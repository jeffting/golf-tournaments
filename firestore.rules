rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper to check if a string is within length limits
    function isValidString(val, min, max) {
      return val is string && val.size() >= min && val.size() <= max;
    }

    // Helper to calculate YYYY-MM string from timestamp
    function getYearMonth() {
      return string(request.time.year()) + "-" + (request.time.month() < 10 ? "0" : "") + string(request.time.month());
    }

    // Helper to check if the user is an admin
    function isAdmin() {
      return request.auth != null && request.auth.token.email == "jefftingey22@gmail.com";
    }

    // Helper to check if time is in HH:mm format
    function isValidTime(val) {
      return val is string && val.matches('^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$');
    }

    // Helper to validate tournament data
    function isValidTournament(data) {
      return isValidString(data.tournamentName, 3, 50)
        && isValidString(data.courseName, 3, 100)
        && data.location.state in ["UT", "AZ"]
        && isValidString(data.location.city, 3, 50)
        && isValidString(data.location.street, 3, 50)
        && isValidString(data.contactEmail, 5, 50)
        && isValidString(data.description, 5, 1000)
        && (data.externalUrl == null || isValidString(data.externalUrl, 0, 80))
        && isValidTime(data.startTime)
        && isValidString(data.timezone, 3, 50)
        && data.createdAt is number;
    }

    // Allow public read access to tournaments
    match /tournaments/{tournament} {
      allow read: if true;
      allow create: if request.auth != null 
        && request.auth.uid == request.resource.data.creatorUserId
        && isValidTournament(request.resource.data)
      // Verify usage counter is updated in this transaction and within limit (admins exempt)
        && (isAdmin() || getAfter(/databases/$(database)/documents/userUsage/$(request.auth.token.email)/monthlyStats/$(getYearMonth())).data.count <= 5);

      allow update: if request.auth != null
        && request.auth.uid == resource.data.creatorUserId
        && request.auth.uid == request.resource.data.creatorUserId // Cannot change creator
        && isValidTournament(request.resource.data);

      allow delete: if request.auth != null && request.auth.uid == resource.data.creatorUserId;
    }

    // Users can only read and write their own data
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId
    }

    match /userUsage/{email}/monthlyStats/{yyyyMM} {
      // Users can see their own usage
      allow read: if request.auth != null && request.auth.token.email == email;
      // Only the user can update their usage, and only by incrementing by 1 within the limit (admins exempt)
      allow write: if request.auth != null && request.auth.token.email == email
        && yyyyMM == getYearMonth()
        && (
      (resource == null && request.resource.data.count == 1) ||
      (request.resource.data.count == resource.data.count + 1)
      )
        && (isAdmin() || request.resource.data.count <= 5);
    }

    // Deny access to everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
