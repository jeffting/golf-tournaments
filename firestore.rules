rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow public read access to tournaments
    match /tournaments/{tournament} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.token.email == request.resource.data.hostEmail;
      allow delete: if request.auth != null && request.auth.token.email == resource.data.hostEmail;
      // allow update: if false; // TBD 

      match /registrations/{registration} {
        // Anyone can register
        allow create: if true 
          // If joining a team, verify the password against the secret
          // Use getAfter() to allow verification when the team/secret is created in the same transaction
          && (
            request.resource.data.teamId == null || 
            request.resource.data.teamPassword == getAfter(/databases/$(database)/documents/tournaments/$(tournament)/teams/$(request.resource.data.teamId)/secrets/config).data.password
          );
        // Only the tournament host can see registrations
        allow read: if request.auth != null && request.auth.token.email == get(/databases/$(database)/documents/tournaments/$(tournament)).data.hostEmail;
      }

      match /teams/{team} {
        // Anyone can see teams (for selection) and create them
        allow read, create: if true;
        // Member count must increment by 1, and password must be verified
        allow update: if request.resource.data.memberCount == resource.data.memberCount + 1
          && request.resource.data.joinPassword == getAfter(/databases/$(database)/documents/tournaments/$(tournament)/teams/$(team)/secrets/config).data.password;

        match /secrets/{secret} {
          // Secrets are never readable
          allow read: if false;
          // Anyone can create a secret (during team creation)
          allow create: if true;
        }
      }
    }
    
    // Deny access to everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
